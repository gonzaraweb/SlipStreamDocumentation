<?xml version="1.0" encoding="UTF-8"?>
<chapter version="5.0" xmlns="http://docbook.org/ns/docbook"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:svg="http://www.w3.org/2000/svg"
         xmlns:m="http://www.w3.org/1998/Math/MathML"
         xmlns:html="http://www.w3.org/1999/xhtml"
         xmlns:db="http://docbook.org/ns/docbook">
  <title>Image Creation Process</title>

  	<para>SlipStream defines two types of images: Normal Images and Base Images.
  	Normal Images are images that SlipStream either builds or that extend other
  	images. Base Images are images built outside of SlipStream and comply with
  	SlipStream contextualization requirements.
  	</para>
  	
  	<para>In this section, you will find specific instructions regarding the
  	creation of both types identified above.</para>

    <section><title>Normal Image Creation Process</title>
  
      <para>In this section, we describe the normal image creation workflow.
      This means the workflow of an image creation, where the reference to this
      image is an existing stock image. For the extended workflow of stock image
      creation, see <xref
      linkend="base_image_creation_process_stratuslab">.</xref> 
      below. The internal image creation steps are as follows:</para>
  
      <para>
        <orderedlist>
          <listitem>
            <para>prerecipe execution. A user defined script to be run before the 
            packages installation.</para>
          </listitem>
          <listitem>
            <para>package installation. One can provide a list of packages to 
            be installed optionally specifying repositories and GPG keys.</para>
          </listitem>
          <listitem>
            <para>recipe execution. A user defined script to be run after the 
            above packages installation.</para>
          </listitem>
        </orderedlist>
       </para>
<!--   
      <orderedlist>
        <listitem>
          <para>If defined, these scripts can be found in the
          <literal>/tmp/slipstream</literal> directory. The script
          <literal>slipstream-remote-script</literal> is the script generated by
          SlipStream and executed on the machine by the orchestrator via ssh. It
          will execute the step 3 and 4 of the above list. The actual
          Internally, this script calls</para>
        </listitem>
  
        <listitem>
          <para></para>
        </listitem>
      </orderedlist>
 -->
    </section>
  
    <section xml:id="base_image_creation_process">
		<title>Base Image Creation Process
		</title>
  		 
		<para>On the base image creation process for StratusLab consult documentation on 
     	the StratusLab project web site <link
      	xlink:href="http://www.stratuslab.eu">http://www.stratuslab.eu</link>
      	</para>

 	<section xml:id="base_image_creation_process_stratuslab">
 		<title>StratusLab cloud</title>

    <figure xml:id="fig-base-image-creation">
      <title>Defining a base image</title>

      <mediaobject>
        <imageobject>
          <imagedata align="center" contentwidth="14cm"
                     fileref="images/MachineImage/machine-image-base.png"
                     format="PNG"></imagedata>
        </imageobject>
      </mediaobject>
    </figure>

	</section>
    
	<section><title>Amazon cloud</title>

		<para>Amazon images used with SlipStream have to be contextualized before
		they can be used in Deployments.</para>

		<para>An image contextualization procedure is very simple and fast.</para>

		<orderedlist>
        	<listitem>Launch an instance of your chosen AMI with Amazon interface.</listitem>
			<listitem>Connect to it with SSH</listitem>
			<listitem>Run the following:
				<programlisting>cat > /usr/bin/awscontext &lt;&lt; EOF
#!/bin/sh -e
# SlipStream contextualization script for VMs on Amazon.
# Usage example:
#  * place to /usr/bin/awscontext
#  * launch from /etc/rc.local

CONTEXT_FILE=/tmp/context.sh

curl -o $CONTEXT_FILE http://169.254.169.254/1.0/user-data

. $CONTEXT_FILE

VARS=`cat $CONTEXT_FILE | egrep -e '^[a-zA-Z\-\_0-9]*=' | sed 's/=.*$//'`
for v in $VARS; do
 export $v
done

INIT_SCRIPT=/tmp/init_extra.sh
echo $SCRIPT_EXEC > $INIT_SCRIPT
sh $INIT_SCRIPT
EOF
chmod 0755 /usr/bin/awscontext
				</programlisting></listitem>

	        <listitem>Add /usr/bin/awscontext to /etc/rc.local</listitem>
    	    <listitem>Create a new image out of the modified one: on the Amazon interface
			for the current instance choose Create Image (EBS AMI) and follow the
			simple instructions.</listitem>
        <listitem>Newly created AMI will appear in the list of your AMIs shortly.</listitem>
	</orderedlist>
	
	<para>Now the new AMI is ready to be used with SlipStream.</para>

	</section>
  </section>

<!-- 
  <section>
    <title>Setting-up a Custom Python Environment</title>

    <para>TODO</para>
  </section>
 -->
 </chapter>
